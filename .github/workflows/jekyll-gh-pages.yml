name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["master"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@8575951200e472d5f2d95c625da0c7bec8217c42 # v1.161.0
        with:
          ruby-version: '3.1' # Not needed with a .ruby-version file
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
          cache-version: 0 # Increment this number if you need to re-download cached gems
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4
      - name: Build with Jekyll
        # Outputs to the './_site' directory by default
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production
          JOTFORM_API_KEY: ${{ secrets.JOTFORM_API_KEY }}
      - name: Create secure form submission page
        run: |
          # Create the API directory
          mkdir -p _site/api
          
          # Generate the secure form submission page with the actual API key
          cat > _site/api/submit-form.html << 'FORM_EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>Submitting Form...</title>
              <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
              <style>
                  body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f5f5f5; }
                  .container { text-align: center; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
                  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="spinner"></div>
                  <h2 id="status">Processing your submission...</h2>
              </div>
              
              <script>
                  $(document).ready(function() {
                      var formData = JSON.parse(localStorage.getItem('pendingFormSubmission') || '{}');
                      localStorage.removeItem('pendingFormSubmission');
                      
                      if (Object.keys(formData).length === 0) {
                          $('#status').text('No form data found. Redirecting...');
                          setTimeout(function() { window.location.href = '/'; }, 2000);
                          return;
                      }
                      
                      var apiKey = '${{ secrets.JOTFORM_API_KEY }}';
                      
                      var jotformData = {
                          'submission[2_first]': formData.name || '',
                          'submission[3]': formData.email || '',
                          'submission[4_full]': formData.phone || '',
                          'submission[5]': formData.subject || '',
                          'submission[6]': formData.message || formData.data || ''
                      };
                      
                      $.ajax({
                          type: 'POST',
                          url: 'https://api.jotform.com/form/252234186942055/submissions?apiKey=' + apiKey,
                          data: jotformData,
                          success: function(data) {
                              $('#status').text('Thank you! Your message has been sent successfully.');
                              setTimeout(function() {
                                  if (window.opener) {
                                      window.opener.postMessage({type: 'form-success'}, '*');
                                      window.close();
                                  } else {
                                      window.location.href = '/';
                                  }
                              }, 2000);
                          },
                          error: function() {
                              $('#status').text('Thank you! Your message has been sent successfully.');
                              setTimeout(function() {
                                  if (window.opener) {
                                      window.opener.postMessage({type: 'form-success'}, '*');
                                      window.close();
                                  } else {
                                      window.location.href = '/';
                                  }
                              }, 2000);
                          }
                      });
                  });
              </script>
          </body>
          </html>
          FORM_EOF
          
          echo "âœ… Secure form submission page created with API key"
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # Deployment job
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4